<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>RabbitMQ Stream PerfTest</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>RabbitMQ Stream PerfTest</h1>
<div class="details">
<span id="revnumber">version 1.5.0-SNAPSHOT</span>
<br><span id="revremark">(2b91576)</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#getting-started">Getting Started</a></li>
<li><a href="#pre-requisites">Pre-requisites</a>
<ul class="sectlevel2">
<li><a href="#with-docker">With Docker</a>
<ul class="sectlevel3">
<li><a href="#with-docker-host-network-driver">With Docker Host Network Driver</a></li>
<li><a href="#with-docker-bridge-network-driver">With Docker Bridge Network Driver</a></li>
</ul>
</li>
<li><a href="#with-the-java-binary">With the Java Binary</a></li>
</ul>
</li>
<li><a href="#common-usage">Common Usage</a>
<ul class="sectlevel2">
<li><a href="#connection">Connection</a></li>
<li><a href="#publishing-rate">Publishing Rate</a></li>
<li><a href="#number-of-producers-and-consumers">Number of Producers and Consumers</a></li>
<li><a href="#streams">Streams</a></li>
<li><a href="#publishing-batch-size">Publishing Batch Size</a></li>
<li><a href="#unconfirmed-messages">Unconfirmed Messages</a></li>
<li><a href="#message-size">Message Size</a></li>
<li><a href="#performance-tool-connection-pooling">Connection Pooling</a></li>
</ul>
</li>
<li><a href="#advanced-usage">Advanced Usage</a>
<ul class="sectlevel2">
<li><a href="#performance-tool-retention">Retention</a></li>
<li><a href="#offset-consumer">Offset (Consumer)</a></li>
<li><a href="#performance-tool-offset-tracking">Offset Tracking (Consumer)</a></li>
<li><a href="#consumer-names">Consumer Names</a></li>
<li><a href="#producer-names">Producer Names</a></li>
<li><a href="#load-balancer-in-front-of-the-cluster">Load Balancer in Front of the Cluster</a></li>
<li><a href="#performance-tool-sac">Single Active Consumer</a></li>
<li><a href="#super-streams">Super Streams</a></li>
<li><a href="#monitoring">Monitoring</a></li>
<li><a href="#performant-tool-instance-synchronization">Synchronizing Several Instances</a></li>
<li><a href="#using-environment-variables-as-options">Using Environment Variables as Options</a></li>
<li><a href="#logging">Logging</a></li>
</ul>
</li>
<li><a href="#building-the-performance-tool">Building the Performance Tool</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>RabbitMQ Stream PerfTest is a Java tool to test the <a href="https://rabbitmq.com/stream.html">RabbitMQ Stream Plugin</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a>Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Stream PerfTest is based on the <a href="https://github.com/rabbitmq/rabbitmq-stream-java-client/" target="_blank" rel="noopener">stream Java client <span class="icon"><i class="fa fa-external-link"></i></span></a> and uses the <a href="https://github.com/rabbitmq/rabbitmq-server/blob/main/deps/rabbitmq_stream/docs/PROTOCOL.adoc" target="_blank" rel="noopener">stream protocol <span class="icon"><i class="fa fa-external-link"></i></span></a> to communicate with a RabbitMQ cluster.
Use <a href="https://perftest.rabbitmq.com" target="_blank" rel="noopener">PerfTest <span class="icon"><i class="fa fa-external-link"></i></span></a> if you want to test streams or queues with <a href="https://www.rabbitmq.com/tutorials/amqp-concepts.html" target="_blank" rel="noopener">AMQP 0.9.1 <span class="icon"><i class="fa fa-external-link"></i></span></a>.</p>
</div>
<div class="paragraph">
<p>Stream PerfTest is usable as an uber JAR
<a href="https://github.com/rabbitmq/rabbitmq-stream-perf-test/releases" target="_blank" rel="noopener">downloadable from GitHub Release <span class="icon"><i class="fa fa-external-link"></i></span></a> or as a <a href="https://hub.docker.com/r/pivotalrabbitmq/stream-perf-test" target="_blank" rel="noopener">Docker image <span class="icon"><i class="fa fa-external-link"></i></span></a>.
It can be built separately as well.</p>
</div>
<div class="paragraph">
<p>Snapshots are on <a href="https://github.com/rabbitmq/rabbitmq-java-tools-binaries-dev/releases" target="_blank" rel="noopener">GitHub release <span class="icon"><i class="fa fa-external-link"></i></span></a> as well.
Use the <code>pivotalrabbitmq/stream-perf-test:dev</code> image to use the latest snapshot in Docker.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pre-requisites"><a class="anchor" href="#pre-requisites"></a>Pre-requisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Stream PerfTest requires Java 11 or later to run.</p>
</div>
<div class="sect2">
<h3 id="with-docker"><a class="anchor" href="#with-docker"></a>With Docker</h3>
<div class="paragraph">
<p>The performance tool is available as a
<a href="https://hub.docker.com/r/pivotalrabbitmq/stream-perf-test" target="_blank" rel="noopener">Docker image <span class="icon"><i class="fa fa-external-link"></i></span></a>.
You can use the Docker image to list the available options:</p>
</div>
<div class="listingblock">
<div class="title">Listing the available options of the performance tool</div>
<div class="content">
<pre>docker run -it --rm pivotalrabbitmq/stream-perf-test --help</pre>
</div>
</div>
<div class="paragraph">
<p>There are all sorts of options, if none is provided, the tool will start publishing to and consuming from a stream created only for the test.</p>
</div>
<div class="paragraph">
<p>When using Docker, the container running the performance tool must be able to connect to the broker, so you have to figure out the appropriate Docker configuration to make this possible.
You can have a look at the <a href="https://docs.docker.com/network/" target="_blank" rel="noopener">Docker network documentation <span class="icon"><i class="fa fa-external-link"></i></span></a> to find out more.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Docker on macOS</div>
<div class="paragraph">
<p>Docker runs on a virtual machine when using macOS, so do not expect high performance  when using RabbitMQ Stream and the performance tool inside Docker on a Mac.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We show next a couple of options to easily use the Docker image.</p>
</div>
<div class="sect3">
<h4 id="with-docker-host-network-driver"><a class="anchor" href="#with-docker-host-network-driver"></a>With Docker Host Network Driver</h4>
<div class="paragraph">
<p>This is the simplest way to run the image locally, with a local broker running in Docker as well.
The containers use the <a href="https://docs.docker.com/network/host/" target="_blank" rel="noopener">host network <span class="icon"><i class="fa fa-external-link"></i></span></a>,
this is perfect for experimenting locally.</p>
</div>
<div class="listingblock">
<div class="title">Running the broker and performance tool with the host network driver</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell"># run the broker
docker run -it --rm --name rabbitmq --network host rabbitmq:4.0
# open another terminal and enable the stream plugin
docker exec rabbitmq rabbitmq-plugins enable rabbitmq_stream
# run the performance tool
docker run -it --rm --network host pivotalrabbitmq/stream-perf-test</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Docker Host Network Driver Support</div>
<div class="paragraph">
<p>According to Docker&#8217;s documentation, the host networking driver <strong>only works on Linux hosts</strong>.
Nevertheless, the commands above work on some Mac hosts.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="with-docker-bridge-network-driver"><a class="anchor" href="#with-docker-bridge-network-driver"></a>With Docker Bridge Network Driver</h4>
<div class="paragraph">
<p>Containers need to be able to communicate with each other with
the <a href="https://docs.docker.com/network/bridge/" target="_blank" rel="noopener">bridge network driver <span class="icon"><i class="fa fa-external-link"></i></span></a>, this
can be done by defining a network and running the containers in this network.</p>
</div>
<div class="listingblock">
<div class="title">Running the broker and performance tool with the bridge network driver</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell"># create a network
docker network create stream-perf-test
# run the broker
docker run -it --rm --network stream-perf-test --name rabbitmq rabbitmq:4.0
# open another terminal and enable the stream plugin
docker exec rabbitmq rabbitmq-plugins enable rabbitmq_stream
# run the performance tool
docker run -it --rm --network stream-perf-test pivotalrabbitmq/stream-perf-test \
    --uris rabbitmq-stream://rabbitmq:5552</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="with-the-java-binary"><a class="anchor" href="#with-the-java-binary"></a>With the Java Binary</h3>
<div class="paragraph">
<p>The Java binary is available on <a href="https://github.com/rabbitmq/rabbitmq-stream-perf-test/releases" target="_blank" rel="noopener">GitHub Release <span class="icon"><i class="fa fa-external-link"></i></span></a>.
<a href="https://github.com/rabbitmq/rabbitmq-java-tools-binaries-dev/releases" target="_blank" rel="noopener">Snapshots <span class="icon"><i class="fa fa-external-link"></i></span></a> are available as well. To use the latest snapshot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>wget https://github.com/rabbitmq/rabbitmq-java-tools-binaries-dev/releases/download/v-stream-perf-test-latest/stream-perf-test-latest.jar</pre>
</div>
</div>
<div class="paragraph">
<p>To launch a run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ java -jar stream-perf-test-latest.jar
17:51:26.207 [main] INFO  c.r.stream.perf.StreamPerfTest - Starting producer
1, published 560277 msg/s, confirmed 554088 msg/s, consumed 556983 msg/s, latency min/median/75th/95th/99th 2663/9799/13940/52304/57995 µs, chunk size 1125
2, published 770722 msg/s, confirmed 768209 msg/s, consumed 768585 msg/s, latency min/median/75th/95th/99th 2454/9599/12206/23940/55519 µs, chunk size 1755
3, published 915895 msg/s, confirmed 914079 msg/s, consumed 916103 msg/s, latency min/median/75th/95th/99th 2338/8820/11311/16750/52985 µs, chunk size 2121
4, published 1004257 msg/s, confirmed 1003307 msg/s, consumed 1004981 msg/s, latency min/median/75th/95th/99th 2131/8322/10639/14368/45094 µs, chunk size 2228
5, published 1061380 msg/s, confirmed 1060131 msg/s, consumed 1061610 msg/s, latency min/median/75th/95th/99th 2131/8247/10420/13905/37202 µs, chunk size 2379
6, published 1096345 msg/s, confirmed 1095947 msg/s, consumed 1097447 msg/s, latency min/median/75th/95th/99th 2131/8225/10334/13722/33109 µs, chunk size 2454
7, published 1127791 msg/s, confirmed 1127032 msg/s, consumed 1128039 msg/s, latency min/median/75th/95th/99th 1966/8150/10172/13500/23940 µs, chunk size 2513
8, published 1148846 msg/s, confirmed 1148086 msg/s, consumed 1149121 msg/s, latency min/median/75th/95th/99th 1966/8079/10135/13248/16771 µs, chunk size 2558
9, published 1167067 msg/s, confirmed 1166369 msg/s, consumed 1167311 msg/s, latency min/median/75th/95th/99th 1966/8063/9986/12977/16757 µs, chunk size 2631
10, published 1182554 msg/s, confirmed 1181938 msg/s, consumed 1182804 msg/s, latency min/median/75th/95th/99th 1966/7963/9949/12632/16619 µs, chunk size 2664
11, published 1197069 msg/s, confirmed 1196495 msg/s, consumed 1197291 msg/s, latency min/median/75th/95th/99th 1966/7917/9955/12503/15386 µs, chunk size 2761
12, published 1206687 msg/s, confirmed 1206176 msg/s, consumed 1206917 msg/s, latency min/median/75th/95th/99th 1966/7893/9975/12503/15280 µs, chunk size 2771
...
^C
Summary: published 1279444 msg/s, confirmed 1279019 msg/s, consumed 1279019 msg/s, latency 95th 12161 µs, chunk size 2910</pre>
</div>
</div>
<div class="paragraph">
<p>The previous command will start publishing to and consuming from a <code>stream</code> stream that
will be created. The tool outputs live metrics on the console and write more
detailed metrics in a <code>stream-perf-test-current.txt</code> file that get renamed to
<code>stream-perf-test-yyyy-MM-dd-HHmmss.txt</code> when the run ends.</p>
</div>
<div class="paragraph">
<p>To see the options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test-latest.jar --help</pre>
</div>
</div>
<div class="paragraph">
<p>The performance tool comes also with a
<a href="https://github.com/rabbitmq/rabbitmq-java-tools-binaries-dev/releases/download/v-stream-perf-test-latest/stream-perf-test-latest_completion" target="_blank" rel="noopener">completion script <span class="icon"><i class="fa fa-external-link"></i></span></a>.
You can download it and enable it in your <code>~/.zshrc</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>alias stream-perf-test='java -jar target/stream-perf-test.jar'
source ~/.zsh/stream-perf-test_completion</pre>
</div>
</div>
<div class="paragraph">
<p>Note the activation requires an alias which must be <code>stream-perf-test</code>. The command can be anything
though.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="common-usage"><a class="anchor" href="#common-usage"></a>Common Usage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="connection"><a class="anchor" href="#connection"></a>Connection</h3>
<div class="paragraph">
<p>The performance tool connects by default to localhost, on port 5552, with
default credentials (<code>guest</code>/<code>guest</code>), on the default <code>/</code> virtual host.
This can be changed with the <code>--uris</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --uris rabbitmq-stream://rabbitmq-1:5552</pre>
</div>
</div>
<div class="paragraph">
<p>The URI follows the same rules as the
<a href="https://www.rabbitmq.com/uri-spec.html" target="_blank" rel="noopener">AMQP 0.9.1 URI <span class="icon"><i class="fa fa-external-link"></i></span></a>,
except the protocol must be <code>rabbitmq-stream</code>.
The next command shows how to set up the different elements of the URI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar \
  --uris rabbitmq-stream://guest:guest@localhost:5552/%2f</pre>
</div>
</div>
<div class="paragraph">
<p>The option accepts several values, separated by commas. By doing so, the tool
will be able to pick another URI for its "locator" connection, in case a node
crashes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar \
  --uris rabbitmq-stream://rabbitmq-1:5552,rabbitmq-stream://rabbitmq-2:5552</pre>
</div>
</div>
<div class="paragraph">
<p>Note the tool uses those URIs only for management purposes, it does not use them
to distribute publishers and consumers across a cluster.</p>
</div>
<div class="paragraph">
<p>It is also possible to enable TLS by using the <code>rabbitmq-stream+tls</code> scheme:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar \
  --uris rabbitmq-stream+tls://guest:guest@localhost:5551/%2f</pre>
</div>
</div>
<div class="paragraph">
<p>Note the performance tool will automatically configure the client to trust all
server certificates and to not use a private key (for client authentication).</p>
</div>
<div class="paragraph">
<p>Have a look at the <a href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/#understanding-connection-logic" target="_blank" rel="noopener">connection logic section <span class="icon"><i class="fa fa-external-link"></i></span></a> of the stream Java client in case of connection problem.</p>
</div>
</div>
<div class="sect2">
<h3 id="publishing-rate"><a class="anchor" href="#publishing-rate"></a>Publishing Rate</h3>
<div class="paragraph">
<p>It is possible to limit the publishing rate with the <code>--rate</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --rate 10000</pre>
</div>
</div>
<div class="paragraph">
<p>RabbitMQ Stream can easily saturate the resources of the hardware, it can especially
max out the storage IO. Reasoning when a system is under severe constraints can
be difficult, so setting a low publishing rate can be a good idea to get familiar
with the performance tool and the semantics of streams.</p>
</div>
</div>
<div class="sect2">
<h3 id="number-of-producers-and-consumers"><a class="anchor" href="#number-of-producers-and-consumers"></a>Number of Producers and Consumers</h3>
<div class="paragraph">
<p>You can set the number of producers and consumers with the <code>--producers</code> and
<code>--consumers</code> options, respectively:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producers 5 --consumers 5</pre>
</div>
</div>
<div class="paragraph">
<p>With the previous command, you should see a higher consuming rate than
publishing rate. It is because the 5 producers publish as fast as they can
and each consumer consume the messages from the 5 publishers. In theory
the consumer rate should be 5 times the publishing rate, but as stated previously,
the performance tool may put the broker under severe constraints, so the numbers
may not add up.</p>
</div>
<div class="paragraph">
<p>You can set a low publishing rate to verify this theory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producers 5 --consumers 5 --rate 10000</pre>
</div>
</div>
<div class="paragraph">
<p>With the previous command, each publisher should publish 10,000 messages per second,
that is 50,000 messages per second overall. As each consumer consumes each published messages,
the consuming rate should be 5 times the publishing rate, that is 250,000 messages per
second. Using a small publishing rate should let plenty of resources to the system,
so the rates should tend towards those values.</p>
</div>
</div>
<div class="sect2">
<h3 id="streams"><a class="anchor" href="#streams"></a>Streams</h3>
<div class="paragraph">
<p>The performance tool uses a <code>stream</code> stream by default, the <code>--streams</code> option allows
specifying streams that the tool will try to create. Note producer
and consumer counts must be set accordingly, as they are not spread across the
stream automatically. The following command will run a test with 3 streams, with
a producer and a consumer on each of them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --streams stream1,stream2,stream3 \
                               --producers 3 --consumers 3</pre>
</div>
</div>
<div class="paragraph">
<p>The stream creation process has the following semantics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the tool always tries to create streams.</p>
</li>
<li>
<p>if the target streams already exist and have the exact same properties
as the ones the tool uses (see <a href="#performance-tool-retention">retention</a> below), the
run will start normally as stream creation is idempotent.</p>
</li>
<li>
<p>if the target streams already exist but do not have the exact same properties
as the ones the tool uses, the run will start normally as well, the tool will output a warning.</p>
</li>
<li>
<p>for any other errors during creation, the run will stop.</p>
</li>
<li>
<p>the streams are not deleted after the run.</p>
</li>
<li>
<p>if you want the tool to delete the streams after a run, use the <code>--delete-streams</code> flag.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Specifying streams one by one can become tedious as their number grows, so the <code>--stream-count</code>
option can be combined with the <code>--streams</code> option to specify a number or a range and a stream name
pattern, respectively. The following table shows the usage of these 2 options and the resulting
exercised streams. Do not forget to also specify the appropriate number of producers and
consumers if you want all the declared streams to be used.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Options</th>
<th class="tableblock halign-left valign-top">Computed Streams</th>
<th class="tableblock halign-left valign-top">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 5 --streams stream</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-1,stream-2,stream-3,stream-4,stream-5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stream count starts at 1.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 5 --streams stream-%d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-1,stream-2,stream-3,stream-4,stream-5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Possible to specify a <a href="https://docs.oracle.com/javase/7/docs/api/java/util/Formatter.html" target="_blank" rel="noopener">Java printf-style format string <span class="icon"><i class="fa fa-external-link"></i></span></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 10 --streams stream-%d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-1,stream-2,stream-3,&#8230;&#8203;, stream-10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not bad, but not correctly sorted alphabetically.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 10 --streams stream-%02d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-01,stream-02,stream-03,&#8230;&#8203;, stream-10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Better for sorting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 10 --streams stream</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-01,stream-02,stream-03,&#8230;&#8203;, stream-10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default format string handles the sorting issue.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 50-500 --streams stream-%03d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-050,stream-051,stream-052,&#8230;&#8203;, stream-500</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ranges are accepted.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stream-count 50-500</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-050,stream-051,stream-052,&#8230;&#8203;, stream-500</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default format string.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="publishing-batch-size"><a class="anchor" href="#publishing-batch-size"></a>Publishing Batch Size</h3>
<div class="paragraph">
<p>The default publishing batch size is 100, that is a publishing frame is sent every 100 messages.
The following command sets the batch size to 50 with the <code>--batch-size</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --batch-size 50</pre>
</div>
</div>
<div class="paragraph">
<p>There is no ideal batch size, it is a tradeoff between throughput and latency.
High batch size values should increase throughput (usually good) and latency (usually not so
good), whereas low batch size should decrease throughput (usually not good) and latency (usually
good).</p>
</div>
</div>
<div class="sect2">
<h3 id="unconfirmed-messages"><a class="anchor" href="#unconfirmed-messages"></a>Unconfirmed Messages</h3>
<div class="paragraph">
<p>A publisher can have at most 10,000 unconfirmed messages at some point. If it reaches this value,
it has to wait until the broker confirms some messages. This avoids fast publishers overwhelming
the broker. The <code>--confirms</code> option allows changing the default value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --confirms 20000</pre>
</div>
</div>
<div class="paragraph">
<p>High values should increase throughput at the cost of consuming more memory, whereas low values
should decrease throughput and memory consumption.</p>
</div>
</div>
<div class="sect2">
<h3 id="message-size"><a class="anchor" href="#message-size"></a>Message Size</h3>
<div class="paragraph">
<p>The default size of a message is 10 bytes, which is rather small. The <code>--size</code> option lets you
specify a different size, usually higher, to have a value close to your use case. The next command
sets a size of 1 KB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --size 1024</pre>
</div>
</div>
<div class="paragraph">
<p>Note the message body size cannot be smaller that 8 bytes, as the performance tool stores
a long in each message to calculate the latency. Note also the actual size of a message will be
slightly higher, as the body is wrapped in an <a href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/#working-with-complex-messages" target="_blank" rel="noopener">AMQP 1.0 message <span class="icon"><i class="fa fa-external-link"></i></span></a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="performance-tool-connection-pooling"><a class="anchor" href="#performance-tool-connection-pooling"></a>Connection Pooling</h3>
<div class="paragraph">
<p>The performance tool does not use connection pooling by default: each producer and consumer has its own connection.
This can be appropriate to reach maximum throughput in performance test runs, as producers and consumers do not share connections.
But it may not always reflect what applications do, as they may have slow producers and not-so-busy consumers, so sharing connections becomes interesting to save some resources.</p>
</div>
<div class="paragraph">
<p>It is possible to configure connection pooling with the <code>--producers-by-connection</code> and <code>--consumers-by-connection</code> options.
They accept a value between 1 and 255, the default being 1 (no connection pooling).</p>
</div>
<div class="paragraph">
<p>In the following example we use 10 streams with 1 producer and 1 consumer on each of them.
As the rate is low, we can re-use connections:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producers 10 --consumers 10 --stream-count 10 \
                               --rate 1000 \
                               --producers-by-connection 50 --consumers-by-connection 50</pre>
</div>
</div>
<div class="paragraph">
<p>We end up using 2 connections for the producers and consumers with connection pooling, instead of 20.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advanced-usage"><a class="anchor" href="#advanced-usage"></a>Advanced Usage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="performance-tool-retention"><a class="anchor" href="#performance-tool-retention"></a>Retention</h3>
<div class="paragraph">
<p>If you run performance tests for a long time, you might be interested in setting
a <a href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/#limiting-the-size-of-a-stream" target="_blank" rel="noopener">retention strategy <span class="icon"><i class="fa fa-external-link"></i></span></a> for
the streams the performance tool creates for a run. This
would typically avoid saturating the storage devices of your servers.
The default values are 20 GB for the maximum size of a stream and
500 MB for each segment files that composes a stream. You can change
these values with the <code>--max-length-bytes</code> and <code>--stream-max-segment-size-bytes</code> options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --max-length-bytes 10gb \
                               --stream-max-segment-size-bytes 250mb</pre>
</div>
</div>
<div class="paragraph">
<p>Both options accept units (<code>kb</code>, <code>mb</code>, <code>gb</code>, <code>tb</code>), as well as no unit to
specify a number of bytes.</p>
</div>
<div class="paragraph">
<p>It is also possible to use the time-based retention strategy with the <code>--max-age</code> option.
This can be less predictable than <code>--max-length-bytes</code> in the context of performance tests though.
The following command shows how to set the maximum age of segments to 5 minutes with
a maximum segment size of 250 MB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --max-age PT5M \
                               --stream-max-segment-size-bytes 250mb</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--max-age</code> option uses the
<a href="https://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener">ISO 8601 duration format <span class="icon"><i class="fa fa-external-link"></i></span></a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="offset-consumer"><a class="anchor" href="#offset-consumer"></a>Offset (Consumer)</h3>
<div class="paragraph">
<p>Consumers start by default at the very end of a stream (offset <code>next</code>).
It is possible to specify an <a href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/#specifying-an-offset" target="_blank" rel="noopener">offset <span class="icon"><i class="fa fa-external-link"></i></span></a>
to start from with the <code>--offset</code> option,
if you have existing streams, and you want to consume from them at a specific offset.
The following command sets the consumer to start consuming at the beginning of
a stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --offset first</pre>
</div>
</div>
<div class="paragraph">
<p>The accepted values for <code>--offset</code> are <code>first</code>, <code>last</code>, <code>next</code> (the default),
an unsigned long for a given offset, and an ISO 8601 formatted timestamp
(eg. <code>2020-06-03T07:45:54Z</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="performance-tool-offset-tracking"><a class="anchor" href="#performance-tool-offset-tracking"></a>Offset Tracking (Consumer)</h3>
<div class="paragraph">
<p>A consumer can <a href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/#consumer-offset-tracking" target="_blank" rel="noopener">track the point <span class="icon"><i class="fa fa-external-link"></i></span></a> it has reached
in a stream to be able to restart where it left off in a new incarnation.
The performance tool has the <code>--store-every</code> option to tell consumers to store
the offset every <code>x</code> messages to be able to measure the impact of offset tracking
in terms of throughput and storage. This feature is disabled by default.
The following command shows how to store the offset every 100,000 messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --store-every 100000</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="consumer-names"><a class="anchor" href="#consumer-names"></a>Consumer Names</h3>
<div class="paragraph">
<p>When using <code>--store-every</code> (see above) for <a href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/#consumer-offset-tracking" target="_blank" rel="noopener">offset tracking <span class="icon"><i class="fa fa-external-link"></i></span></a>,
the performance tool uses a default name using the pattern <code>{stream-name}-{consumer-number}</code>.
So the default name of a single tracking consumer consuming from <code>stream</code> will be <code>stream-1</code>.</p>
</div>
<div class="paragraph">
<p>The consumer names pattern can be set with the <code>--consumer-names</code> option, which uses
the <a href="https://docs.oracle.com/javase/7/docs/api/java/util/Formatter.html" target="_blank" rel="noopener">Java printf-style format string <span class="icon"><i class="fa fa-external-link"></i></span></a>.
The stream name and the consumer number are injected as arguments, in this order.</p>
</div>
<div class="paragraph">
<p>The following table illustrates some examples for the <code>--consumer-names</code> option
for a <code>s1</code> stream and a second consumer:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Computed Name</th>
<th class="tableblock halign-left valign-top">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%s-%d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>s1-2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default pattern.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-%s-consumer-%d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stream-s1-consumer-2</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>consumer-%2$d-on-stream-%1$s</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>consumer-2-on-stream-s1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The argument indexes (<code>1$</code> for the stream, <code>2$</code> for the consumer number) must be used
as the pattern uses the consumer number first, which is not the pre-defined order of arguments.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uuid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7cc75659-ea67-4874-96ef-151a505e1a55</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.oracle.com/javase/7/docs/api/java/util/UUID.html#randomUUID()" target="_blank" rel="noopener">Random UUID <span class="icon"><i class="fa fa-external-link"></i></span></a> that
changes for every run.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note you can use <code>--consumer-names uuid</code> to change the consumer names for every run. This
can be useful when you want to use tracking consumers in different runs but you want to
force the offset they start consuming from. With consumer names that do not change between runs,
tracking consumers would ignore the specified offset and would start where they left off
(this is the purpose of offset tracking).</p>
</div>
</div>
<div class="sect2">
<h3 id="producer-names"><a class="anchor" href="#producer-names"></a>Producer Names</h3>
<div class="paragraph">
<p>You can use the <code>--producer-names</code> option to set the producer names pattern and therefore
enable <a href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/#outbound-message-deduplication" target="_blank" rel="noopener">message deduplication <span class="icon"><i class="fa fa-external-link"></i></span></a> (using the default
publishing sequence starting at 0 and incremented for each message).
The same naming options apply as above in <a href="#consumer-names">consumer names</a> with the only
difference that the default pattern is empty (i.e. no deduplication).</p>
</div>
<div class="paragraph">
<p>Here is an example of the usage of the <code>--producer-names</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producer-names %s-%d</pre>
</div>
</div>
<div class="paragraph">
<p>The run will start one producer and will use the <code>stream-1</code> producer reference (default stream is <code>stream</code> and the number of the producer is 1.)</p>
</div>
</div>
<div class="sect2">
<h3 id="load-balancer-in-front-of-the-cluster"><a class="anchor" href="#load-balancer-in-front-of-the-cluster"></a>Load Balancer in Front of the Cluster</h3>
<div class="paragraph">
<p>A load balancer can misguide the performance tool when it tries to connect to nodes that host stream leaders and replicas.
The <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/">Connecting to Streams</a> blog post covers why client applications must connect to the appropriate nodes in a cluster.</p>
</div>
<div class="paragraph">
<p>Use the <code>--load-balancer</code> flag to make sure the performance tool always goes through the load balancer that sits in front of your cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --uris rabbitmq-stream://my-load-balancer:5552 \
                               --load-balancer</pre>
</div>
</div>
<div class="paragraph">
<p>The same blog post covers why a <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/#with-a-load-balancer" target="_blank" rel="noopener">load balancer can make things more complicated <span class="icon"><i class="fa fa-external-link"></i></span></a> for client applications like the performance tool and how <a href="https://blog.rabbitmq.com/posts/2021/07/connecting-to-streams/#client-workaround-with-a-load-balancer" target="_blank" rel="noopener">they can mitigate these issues <span class="icon"><i class="fa fa-external-link"></i></span></a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="performance-tool-sac"><a class="anchor" href="#performance-tool-sac"></a>Single Active Consumer</h3>
<div class="paragraph">
<p>If the <code>--single-active-consumer</code> flag is set, the performance tool will create <a href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/#single-active-consumer" target="_blank" rel="noopener">single active consumer <span class="icon"><i class="fa fa-external-link"></i></span></a> instances.
This means that if there are more consumers than streams, there will be only one active consumer at a time on a stream, <em>if they share the same name</em>.
Note <a href="#performance-tool-offset-tracking">offset tracking</a> gets enabled automatically if it&#8217;s not with <code>--single-active-consumer</code> (using 10,000 for <code>--store-every</code>).
Let&#8217;s see a couple of examples.</p>
</div>
<div class="paragraph">
<p>In the following command we have 1 producer publishing to 1 stream and 3 consumers on this stream.
As <code>--single-active-consumer</code> is used, only one of these consumers will be active at a time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producers 1 --consumers 3 --single-active-consumer \
                               --consumer-names my-app</pre>
</div>
</div>
<div class="paragraph">
<p>Note we use a fixed value for the consumer names: if they don&#8217;t have the same name, the broker will not consider them as a group of consumers, so they will all get messages, like regular consumers.</p>
</div>
<div class="paragraph">
<p>In the following example we have 2 producers for 2 streams and 6 consumers overall (3 for each stream).
Note the consumers have the same name on their streams with the use of <code>--consumer-names my-app-%s</code>, as <code>%s</code> is a <a href="#consumer-names">placeholder for the stream name</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producers 2 --consumers 6 --stream-count 2 \
                               --single-active-consumer --consumer-names my-app-%s</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="super-streams"><a class="anchor" href="#super-streams"></a>Super Streams</h3>
<div class="paragraph">
<p>The performance tool has a <code>--super-streams</code> flag to enable <a href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/#super-streams" target="_blank" rel="noopener">super streams <span class="icon"><i class="fa fa-external-link"></i></span></a> on the publisher and consumer sides.
This support is meant to be used with the <a href="#performance-tool-sac"><code>--single-active-consumer</code> flag</a>, to <a href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/#super-stream-sac" target="_blank" rel="noopener">benefit from both features <span class="icon"><i class="fa fa-external-link"></i></span></a>.
We recommend reading the appropriate sections of the documentation to understand the semantics of the flags before using them.
Let&#8217;s see some examples.</p>
</div>
<div class="paragraph">
<p>The example below creates 1 producer and 3 consumers on the default <code>stream</code>, which is now a <em>super stream</em> because of the <code>--super-streams</code> flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producers 1 --consumers 3 --single-active-consumer \
                               --super-streams --consumer-names my-app</pre>
</div>
</div>
<div class="paragraph">
<p>The performance tool creates 3 individual streams by default, they are the partitions of the super stream.
They are named <code>stream-0</code>, <code>stream-1</code>, and <code>stream-2</code>, after the name of the super stream, <code>stream</code>.
The producer will publish to each of them, using a <a href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/#super-stream-producer" target="_blank" rel="noopener">hash-based routing strategy <span class="icon"><i class="fa fa-external-link"></i></span></a>.</p>
</div>
<div class="paragraph">
<p>A consumer is <em>composite</em> with <code>--super-streams</code>: it creates a consumer instance for each partition.
This is 9 consumer instances overall – 3 composite consumers and 3 partitions – spread evenly across the partitions, but with only one active at a time on a given stream.</p>
</div>
<div class="paragraph">
<p>Note we use a fixed consumer name so that the broker considers the consumers belong to the same group and enforce the single active consumer behavior.</p>
</div>
<div class="paragraph">
<p>The next example is more convoluted.
We are going to work with 2 super streams (<code>--stream-count 2</code> and <code>--super-streams</code>).
Each super stream will have 5 partitions (<code>--super-stream-partitions 5</code>), so this is 10 streams overall (<code>stream-1-0</code> to <code>stream-1-4</code> and <code>stream-2-0</code> to <code>stream-2-4</code>).
Here is the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --producers 2 --consumers 6 --stream-count 2 \
                               --super-streams --super-stream-partitions 5 \
                               --single-active-consumer \
                               --consumer-names my-app-%s</pre>
</div>
</div>
<div class="paragraph">
<p>We see also that each super stream has 1 producer (<code>--producers 2</code>) and 3 consumers (<code>--consumers 6</code>).
The composite consumers will spread their consumer instances across the partitions.
Each partition will have 3 consumers but only 1 active at a time with <code>--single-active-consumer</code> and <code>--consumer-names my-app-%s</code> (the consumers on a given stream have the same name, so the broker make sure only one consumes at a time).</p>
</div>
<div class="paragraph">
<p>Note the performance tool does not use <a href="#performance-tool-connection-pooling">connection pooling</a> by default.
The command above opens a significant number of connections – 30 just for consumers – and may not reflect exactly how applications are deployed in the real world.
Don&#8217;t hesitate to use the <code>--producers-by-connection</code> and <code>--consumers-by-connection</code> options to make the runs as close to your workloads as possible.</p>
</div>
</div>
<div class="sect2">
<h3 id="monitoring"><a class="anchor" href="#monitoring"></a>Monitoring</h3>
<div class="paragraph">
<p>The tool can expose some runtime information on HTTP.
The default port is 8080.
The following options are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--monitoring</code>: add a <code>threaddump</code> endpoint to display a thread dump of the process.
This can be useful to inspect threads if the tool seems blocked.</p>
</li>
<li>
<p><code>--prometheus</code>: add a <code>metrics</code> endpoint to expose metrics using the Prometheus format.
The endpoint can then be declared in a Prometheus instance to scrape the metrics.</p>
</li>
<li>
<p><code>--monitoring-port</code>: set the port to use for the web server.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="performant-tool-instance-synchronization"><a class="anchor" href="#performant-tool-instance-synchronization"></a>Synchronizing Several Instances</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This feature is available only on Java 11 or more.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Instances of the performance tool can synchronize to start at the same time.
This can prove useful when you apply different workloads and want to compare them on the same monitoring graphics.
The <code>--id</code> flag identifies the group of instances that need to synchronize and the <code>--expected-instances</code> flag sets the size of the group.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start a couple of instances to compare the impact of message size.
The first instance uses 100-byte message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --id msg-size-comparison --expected-instances 2 \
                               --size 100</pre>
</div>
</div>
<div class="paragraph">
<p>The instance will wait until the second one is ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --id msg-size-comparison --expected-instances 2 \
                               --size 200</pre>
</div>
</div>
<div class="paragraph">
<p>Both instances <em>must</em> share the same <code>--id</code> if they want to communicate to synchronize.</p>
</div>
<div class="paragraph">
<p>The default synchronization timeout is 10 minutes.
This can be changed with the <code>--instance-sync-timeout</code> flag, using a value in seconds.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Instance synchronization is compatible with <a href="https://perftest-dev.rabbitmq.com/#instance-synchronization" target="_blank" rel="noopener">PerfTest <span class="icon"><i class="fa fa-external-link"></i></span></a>, the AMQP 0.9.1 performance tool for RabbitMQ: instances of both tools can synchronize with each other.
The 2 tools use the same flags for this feature.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Instance synchronization requires <a href="https://en.wikipedia.org/wiki/IP_multicast" target="_blank" rel="noopener">IP multicast <span class="icon"><i class="fa fa-external-link"></i></span></a> to be available.
IP multicast is not necessary when the performance tool runs on Kubernetes pods.
In this case, the tool asks Kubernetes for a list of pod IPs.
The performance tool instances are expected to run in the same namespace, and the namespace must be available in the <code>MY_POD_NAMESPACE</code> environment variable or provided with the <code>--instance-sync-namespace</code> flag.
As soon as the namespace information is available, the tool will prefer listing pod IPs over using IP multicast.
Here is an example of using instance synchronization on Kubernetes by providing the namespace explicitly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --id workload-1 --expected-instances 2 \
                               --instance-sync-namespace qa</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The performance tool needs permission to ask Kubernetes for a list of pod IPs.
This is done by creating various policies e.g. with YAML.
See the <a href="https://github.com/jgroups-extras/jgroups-kubernetes" target="_blank" rel="noopener">Kubernetes discovery protocol for JGroups page <span class="icon"><i class="fa fa-external-link"></i></span></a> for more information.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="using-environment-variables-as-options"><a class="anchor" href="#using-environment-variables-as-options"></a>Using Environment Variables as Options</h3>
<div class="paragraph">
<p>Environment variables can sometimes be easier to work with than command line options.
This is especially true when using a manifest file for configuration (with Docker Compose or Kubernetes) and the number of options used grows.</p>
</div>
<div class="paragraph">
<p>The performance tool automatically uses environment variables that match the snake case version of its long options.
E.g. it automatically picks up the value of the <code>BATCH_SIZE</code> environment variable for the <code>--batch-size</code> option, but only if the environment variable is defined.</p>
</div>
<div class="paragraph">
<p>You can list the environment variables that the tool picks up with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar stream-perf-test.jar --environment-variables</pre>
</div>
</div>
<div class="paragraph">
<p>The short version of the option is <code>-env</code>.</p>
</div>
<div class="paragraph">
<p>To avoid collisions with environment variables that already exist, it is possible to specify a prefix for the environment variables that the tool looks up.
This prefix is defined with the <code>RABBITMQ_STREAM_PERF_TEST_ENV_PREFIX</code> environment variable, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RABBITMQ_STREAM_PERF_TEST_ENV_PREFIX="STREAM_PERF_TEST_"</pre>
</div>
</div>
<div class="paragraph">
<p>With <code>RABBITMQ_STREAM_PERF_TEST_ENV_PREFIX="STREAM_PERF_TEST_"</code> defined, the tool looks for the <code>STREAM_PERF_TEST_BATCH_SIZE</code> environment variable, not <code>BATCH_SIZE</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="logging"><a class="anchor" href="#logging"></a>Logging</h3>
<div class="paragraph">
<p>The performance tool binary uses Logback with an internal configuration file.
The default log level is <code>warn</code> with a console appender.</p>
</div>
<div class="paragraph">
<p>It is possible to define loggers directly from the command line, this is useful for quick debugging.
Use the <code>rabbitmq.streamperftest.loggers</code> system property with <code>name=level</code> pairs, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -Drabbitmq.streamperftest.loggers=com.rabbitmq.stream=debug -jar stream-perf-test.jar</pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to define several loggers by separating them with commas, e.g. <code>-Drabbitmq.streamperftest.loggers=com.rabbitmq.stream=debug,com.rabbitmq.stream.perf=info</code>.</p>
</div>
<div class="paragraph">
<p>It is also possible to use an environment variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>export RABBITMQ_STREAM_PERF_TEST_LOGGERS=com.rabbitmq.stream=debug</pre>
</div>
</div>
<div class="paragraph">
<p>The system property takes precedence over the environment variable.</p>
</div>
<div class="paragraph">
<p>Use the environment variable with the Docker image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker run -it --rm --network host \
    --env RABBITMQ_STREAM_PERF_TEST_LOGGERS=com.rabbitmq.stream=debug \
    pivotalrabbitmq/stream-perf-test</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building-the-performance-tool"><a class="anchor" href="#building-the-performance-tool"></a>Building the Performance Tool</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To build the uber JAR:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./mvnw clean package -Dmaven.test.skip</pre>
</div>
</div>
<div class="paragraph">
<p>Then run the tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar target/stream-perf-test.jar</pre>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.5.0-SNAPSHOT<br>
Last updated 2025-02-21 05:01:52 UTC
</div>
</div>
</body>
</html>